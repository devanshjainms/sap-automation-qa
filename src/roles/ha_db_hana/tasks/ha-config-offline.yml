# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------
# |                          HA Configuration Validation                       |
# +--------------------------------------------------------------------------*/

- name:                                 "Find all CIB files in offline_validation directory"
  ansible.builtin.find:
    paths:                              "{{ _workspace_directory }}/offline_validation/"
    patterns:                           "cib"
    recurse:                            true
  register:                             cib_files
  delegate_to:                          localhost

- name:                                 "Get DB hostnames from inventory"
  ansible.builtin.set_fact:
    db_hostnames:                       "{{ groups
                                          | dict2items
                                          | selectattr('key', 'match', '.*_DB$')
                                          | map(attribute='value')
                                          | flatten }}"

- name:                                 "Filter CIB files for DB hosts only"
  ansible.builtin.set_fact:
    db_cib_files:                       "{{ cib_files.files
                                          | selectattr('path', 'match', '.*offline_validation/(' + (db_hostnames | join('|')) + ')/cib$')
                                          | list }}"
  when:                                 cib_files.files | length > 0 and db_hostnames | length > 0

- name:                                 "Set empty list if no DB hosts found"
  ansible.builtin.set_fact:
    db_cib_files:                       []
  when:                                 db_hostnames | default([]) | length == 0

- name:                                 "Debug message when no DB hosts found"
  ansible.builtin.debug:
    msg:                                "No hosts found for Database layer, validation not run"
  when:                                 db_cib_files | default([]) | length == 0

- name:                                 "Process HA Configuration for each DB host"
  ansible.builtin.include_tasks:        "./roles/misc/tasks/offline-validation.yml"
  loop:                                 "{{ db_cib_files | default([]) }}"
  loop_control:
    loop_var:                           offline_validation_host
  when:                                 db_cib_files | default([]) | length > 0
