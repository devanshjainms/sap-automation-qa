# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |    Send check results directly to Python for fast telemetry processing    |
# +------------------------------------4--------------------------------------*/

- name:                             "Build system context map for all hosts"
  ansible.builtin.set_fact:
    _system_context_map:            "{{ _system_context_map | default({}) | combine({item: hostvars[item].system_context}) }}"
  loop:                             "{{ combined_results | map(attribute='hostname') | unique | list }}"
  loop_control:
    label:                          "{{ item }}"

- name:                             "Send check results to Python for batch telemetry processing"
  no_log:                           true
  ansible.builtin.include_role:
    name:                           misc
    tasks_from:                     post-telemetry-data.yml
  vars:
    test_group_json_data:           "{{ combined_results | selectattr('status', 'ne', 'SKIPPED') | list }}"
    common_vars:
      test_group_invocation_id:     "{{ test_group_invocation_id }}"
      group_start_time:             "{{ group_start_time }}"
      group_name:                   "ConfigurationChecks"
      NFS_provider:                 "{{ NFS_provider | default('unknown') }}"
      package_versions:             "{{ package_versions | default('') }}"
      execution_tags:               "{{ execution_tags | default('') }}"
    system_context_map:             "{{ _system_context_map }}"
