# Enumeration definitions
enums:
  severity:
    - info:                           &info "INFO"
    - high:                           &high "HIGH"
    - low:                            &low "LOW"
    - warning:                        &warning "WARNING"
    - critical:                       &critical "CRITICAL"
    - all_severity:                   &severity [*info, *high, *low, *warning, *critical]

  os_type:
    - suse:                           &suse "SLES_SAP"
    - redhat:                         &redhat "REDHAT"
    - oraclelinux:                    &oraclelinux "OracleLinux"
    - windows:                        &windows "Windows"
    - all_os:                         &os_type [*suse, *redhat, *oraclelinux, *windows]

  os_version:
    - suse_12_3:                      &suse_12_3 "SUSE 12 SP3"
    - suse_12_4:                      &suse_12_4 "SUSE 12 SP4"
    - suse_12_5:                      &suse_12_5 "SUSE 12 SP5"
    - all_versions:                   &all_versions "all"

  hardware_type:
    - vm:                             &vm "VM"
    - hli:                            &hli "HLI"
    - all_hardware:                   &all_hardware [*vm, *hli]

  storage_type:
    premium_storage:                  &premium_storage ["Premium_LRS","UltraSSD_LRS","ANF","PremiumV2_LRS","AFS"]
    anf:                              &anf ["ANF"]
    all_storage:                      &all_storage ["Premium_LRS","UltraSSD_LRS","StandardSSD_LRS","Standard_LRS","ANF","PremiumV2_LRS","AFS"]

  workload:
    - sap:                            &sap "SAP"
    - all_workload:                   &workload [*sap]

  db:
    - hana:                           &hana "HANA"
    - mssql:                          &mssql "MSSQL"
    - oracle:                         &oracle "Oracle"
    - db2:                            &db2 "Db2"
    - ase:                            &ase "ASE"
    - all_db:                         &db [*hana, *mssql, *oracle, *db2, *ase]

  role:
    - db:                             &db_role "DB"
    - ascs:                           &ascs_role "SCS"
    - ers:                            &ers_role "ERS"
    - app:                            &app_role "APP"
    - webdispatcher:                  &web_dispatch "WEB"
    - pas:                            &pas "PAS"
    - all_role:                       &role [*db_role, *ascs_role, *ers_role, *app_role, *web_dispatch, *pas]

  cluster_type:
    - sbd:                            &sbd "ISCSI"
    - fencing_agent:                  &fencing_agent "AFA"
    - all_fencing_agent:              &cluster_type [*sbd, *fencing_agent]

  high_availability:
    - no_ha:                         &no_high_availability "false"
    - scale_up:                      &scale_up "scale_up"
    - scale_out:                     &scale_out "scale_out"
    - all_ha:                        &high_availability [*scale_up, *scale_out]

  collector_type:
    - command:                        &command "command"
    - azure:                          &azure "azure"
    - all_collector_type:             &collector_type [*command, *azure]

  category:
    - package:                        &package_check "Package"
    - vm:                             &vm_check "Virtual Machine"
    - sap:                            &sap_check "SAP"
    - os:                             &os_check "Operating System"
    - all_check_types:                &category [*package_check, *vm_check, *sap_check, *os_check]

  user:
    - root:                           &root "root"
    - sidadm:                         &sidadm "sidadm"
    - all_users:                      &user [*root, *sidadm]

  validator_type:
    - string:                         &string "string"
    - range:                          &range "range"
    - list:                           &list "list"
    - check_support:                  &check_support "check_support"
    - all:                            &validator_type [*string, *range, *list]

  report:
    - check:                          &check "check"
    - section:                        &section "section"
    - report:                         &report [*check, *section]

# Checks for more than SAP roles, e.g. ASCS+ERS, ASCS+DB, ASCS+APP etc.
checks:
  - id:                               "SAP-0001"
    name:                             "Supported VM with supplied VM Role and Database"
    description:                      "Is the VM Type support for SAP on Azure in this scenario"
    category:                         *sap_check
    severity:                         *high
    workload:                         *sap
    applicability:
      os_type:                        *os_type
      os_version:                     *all_versions
      hardware_type:                  *all_hardware
      storage_type:                   *all_storage
      role:                           *role
      database_type:                  *db
    collector_type:                   *command
    collector_args:
      command:                        curl -s --noproxy '*' -H Metadata:true 'http://169.254.169.254/metadata/instance/compute/vmSize?api-version=2021-02-01&format=text'
    validator_type:                   *check_support
    validator_args:
      validation_rules:               "SupportedVMs"
    report:                           *check
    references:
      microsoft:                      "https://learn.microsoft.com/en-us/azure/sap/workloads/certifications"
      sap:                            "1928533"

  - id:                               "SAP-0002"
    name:                             "OS/DB combination supported"
    description:                      "Is OS/DB combination supported for SAP on Azure"
    category:                         *sap_check
    severity:                         *high
    workload:                         *sap
    applicability:
      os_type:                        *os_type
      os_version:                     *all_versions
      hardware_type:                  *all_hardware
      storage_type:                   *all_storage
      role:                           *role
      database_type:                  *db
    collector_type:                   *command
    collector_args:
      command:                        curl -s --noproxy '*' -H Metadata:true 'http://169.254.169.254/metadata/instance/compute/storageProfile/imageReference/publisher?api-version=2021-02-01&format=text'
    validator_type:                   *check_support
    validator_args:
      validation_rules:               "SupportedOSDBCombinations"
    report:                           *check
    references:
      microsoft:                      "https://learn.microsoft.com/en-us/azure/sap/workloads/certifications"
      sap:                            "1928533"

  - id:                               "SAP-0003"
    name:                             "stonith-enabled"
    description:                      "Is stonith-enabled set to true"
    category:                         *sap_check
    severity:                         *high
    workload:                         *sap
    applicability:
      os_type:                        [*suse, *redhat]
      os_version:                     *all_versions
      hardware_type:                  *all_hardware
      storage_type:                   *all_storage
      role:                           [*ascs_role, *db_role]
      database_type:                  [*hana]
      high_availability:              *high_availability
      high_availability_agent:        [*cluster_type]
    collector_type:                   *command
    collector_args:
      command: |
                                      cibadmin --query --xpath "//nvpair[@name='stonith-enabled']" | grep -o 'value="[^"]*"' | cut -d'"' -f2
    validator_type:                   *string
    validator_args:
      expected_output:                "true"
    report:                           *check

  - id:                                 "SAP-0004"
    name:                               "stonith-timeout"
    description:                        "SAP stonith timeout (fencing)"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse, *redhat]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          [*cluster_type]
    collector_type:                     *command
    collector_args:
      command: |
                                        cibadmin --query --xpath "//nvpair[@name='stonith-timeout']" | grep -o 'value="[^"]*"' | cut -d'"' -f2
    validator_type:                     *range
    validator_args:
      min:                              "144"
      max:                              "900"
    report:                             *check

  - id:                                 "SAP-0005"
    name:                               "Pacemaker corosync token"
    description:                        "SAP Pacemaker corosync token"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *all_hardware
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          *cluster_type
    collector_type:                     *command
    collector_args:
      command:                          "corosync-cmapctl -g runtime.config.totem.token | awk -F'= ' '{print $2}'"
    validator_type:                     *string
    validator_args:
      expected_output:                  "30000"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0006"
    name:                               "Pacemaker corosync token_retransmits_before_loss_const"
    description:                        "SAP Pacemaker corosync token_retransmits_before_loss_const"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *all_hardware
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          *cluster_type
    collector_type:                     *command
    collector_args:
      command:                          "/usr/sbin/crm corosync get totem.token_retransmits_before_loss_const"
    validator_type:                     *string
    validator_args:
      expected_output:                  "10"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0007"
    name:                               "Pacemaker corosync join"
    description:                        "SAP Pacemaker corosync join"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          *cluster_type
    collector_type:                     *command
    collector_args:
      command:                          "/usr/sbin/crm corosync get totem.join"
    validator_type:                     *string
    validator_args:
      expected_output:                  "60"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0008"
    name:                               "Pacemaker corosync consensus"
    description:                        "SAP Pacemaker corosync consensus"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          *cluster_type
    collector_type:                     *command
    collector_args:
      command:                          "corosync-cmapctl -g runtime.config.totem.consensus | awk -F'= ' '{print $2}'"
    validator_type:                     *string
    validator_args:
      expected_output:                  "36000"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0009"
    name:                               "Pacemaker corosync max_messages"
    description:                        "SAP Pacemaker corosync max_messages"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          *cluster_type
    collector_type:                     *command
    collector_args:
      command:                          "/usr/sbin/crm corosync get totem.max_messages"
    validator_type:                     *string
    validator_args:
      expected_output:                  "20"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0010"
    name:                               "Pacemaker corosync expected_votes"
    description:                        "SAP Pacemaker corosync expected_votes"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          *cluster_type
    collector_type:                     *command
    collector_args:
      command:                          "/usr/sbin/crm corosync get quorum.expected_votes"
    validator_type:                     *string
    validator_args:
      expected_output:                  "2"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0011"
    name:                               "Pacemaker corosync two_node"
    description:                        "SAP Pacemaker corosync two_node"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          *cluster_type
    collector_type:                     *command
    collector_args:
      command:                          "/usr/sbin/crm corosync get quorum.two_node"
    validator_type:                     *string
    validator_args:
      expected_output:                  "1"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0012"
    name:                               "concurrent-fencing"
    description:                        "SAP concurrent fencing (fencing)"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse, *redhat]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          [*fencing_agent]
    collector_type:                     *command
    collector_args:
      command:                          /usr/sbin/crm_attribute --name concurrent-fencing --query --quiet
    validator_type:                     *string
    validator_args:
      expected_output:                  "true"
    report:                             *check

  - id:                                 "SAP-0013"
    name:                               "Pacemaker number of fence_azure_arm instances"
    description:                        "SAP Pacemaker number of fence_azure_arm instances"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse, *redhat]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          [*fencing_agent]
    collector_type:                     *command
    collector_args:
      command:                          cibadmin -Q --xpath "//resources/primitive[@class='stonith']" | grep "<primitive" | wc -l
    validator_type:                     *string
    validator_args:
      expected_output:                  "1"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0014"
    name:                               "Pacemaker softdog config file"
    description:                        "SAP Pacemaker softdog config file"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          [*cluster_type]
    collector_type:                     *command
    collector_args:
      command:                          "/bin/cat /etc/modules-load.d/softdog.conf"
    validator_type:                     *string
    validator_args:
      expected_output:                  "softdog"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0015"
    name:                               "Pacemaker softdog module loaded"
    description:                        "SAP Pacemaker softdog module loaded"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*suse]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          [*sbd]
    collector_type:                     *command
    collector_args:
      command:                          "lsmod | grep softdog | wc -l"
    validator_type:                     *string
    validator_args:
      expected_output:                  "1"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-suse-pacemaker"

  - id:                                 "SAP-0016"
    name:                               "Pacemaker corosync token"
    description:                        "SAP Pacemaker corosync token"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*redhat]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          [*fencing_agent]
    collector_type:                     *command
    collector_args:
      command:                          "grep -E '^[[:space:]]*token:' /etc/corosync/corosync.conf | awk '{print $2}'"
    validator_type:                     *string
    validator_args:
      expected_output:                  "30000"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-rhel-pacemaker"

  - id:                                 "SAP-0017"
    name:                               "Pacemaker expected_votes"
    description:                        "SAP HANA Pacemaker expected_votes"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*redhat]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          [*fencing_agent]
    collector_type:                     *command
    collector_args:
      command:                          "/sbin/pcs quorum status | xargs | grep -i 'Expected votes: 2' | wc -l"
    validator_type:                     *string
    validator_args:
      expected_output:                  "1"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-rhel-pacemaker"

  - id:                                 "SAP-0018"
    name:                               "Pacemaker optional fence_kdump"
    description:                        "SAP Pacemaker optional fence_kdump"
    category:                           *sap_check
    severity:                           *high
    workload:                           *sap
    applicability:
      os_type:                          [*redhat]
      os_version:                       *all_versions
      hardware_type:                    *vm
      storage_type:                     *all_storage
      role:                             [*db_role, *ascs_role]
      database_type:                    [*hana]
      high_availability:                *high_availability
      high_availability_agent:          [*fencing_agent]
    collector_type:                     *command
    collector_args:
      command:                          "/sbin/pcs config show | grep -i 'fence_kdump' | wc -l"
    validator_type:                     *string
    validator_args:
      expected_output:                  "1"
    report:                             *check
    references:
      microsoft:                        "https://learn.microsoft.com/en-us/azure/sap/workloads/high-availability-guide-rhel-pacemaker"
