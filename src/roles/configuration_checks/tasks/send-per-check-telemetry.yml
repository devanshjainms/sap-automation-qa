# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                           Post                               |
# +------------------------------------4--------------------------------------*/

- name:                             "Send telemetry for configuration check {{ check_result.id | default(check_result.check.id | default('')) }}"
  delegate_to:                      localhost
  block:
    - name:                         "When parameters present - build telemetry batch list"
      when:                         "(check_result.details is defined and check_result.details.parameters is defined and (check_result.details.parameters | length) > 0)"
      set_fact:
        _telemetry_batch:           "[]"

    - name:                         "Append parameter entries to telemetry batch"
      when:                         "(check_result.details is defined and check_result.details.parameters is defined and (check_result.details.parameters | length) > 0)"
      loop:                         "{{ check_result.details.parameters }}"
      loop_control:
        loop_var:                   param
      set_fact:
        _telemetry_batch:           "{{ _telemetry_batch + [ {
                                      'TestCaseInvocationId': (param.id | default(param.name | default(''))),
                                      'TestCaseStartTime': (check_result.timestamp | default(now())),
                                      'TestCaseEndTime': (check_result.timestamp | default(now())),
                                      'TestCaseStatus': (param.status | default(check_result.status | default(''))),
                                      'TestCaseName': (param.name | default(param.id | default(''))),
                                      'TestCaseDescription': ('Parameter ' + (param.name | default(param.id | default(''))) + ' in category ' + (param.category | default('')) ),
                                      'TestGroupInvocationId': lookup('vars', 'test_group_invocation_id', default=''),
                                      'TestGroupStartTime': lookup('vars', 'group_start_time', default=''),
                                      'TestGroupName': lookup('vars', 'group_name', default='ConfigurationChecks'),
                                      'OsVersion': (system_context.os_type | default(system_context.os_version | default(''))),
                                      'TestCaseMessage': ('Actual=' + (param.value | default('')) + ' Expected=' + (param.expected_value | default(''))),
                                      'TestCaseDetails': (param | to_json),
                                      'DurationSeconds': 0,
                                      'StorageType': (system_context.storage_type | default('unknown')),
                                      'PackageVersions': lookup('vars', 'package_versions', default=''),
                                      'Tags': lookup('vars', 'execution_tags', default=''),
                                      'TestExecutionStartTime': (check_result.timestamp | default(now())),
                                      'TestExecutionEndTime': (check_result.timestamp | default(now())),
                                      'TestCaseHostname': (check_result.hostname | default(system_context.hostname | default(''))),
                                      'TestCaseLogMessagesFromSap': (check_result.details | default(''))
                                    } ] }}"

    - name:                         "If batch exists, send batch in single call"
      when:                         "_telemetry_batch is defined and (_telemetry_batch | length) > 0"
      include_role:
        name:                       misc
        tasks_from:                 post-telemetry-data.yml
      vars:
        test_group_json_data:       "{{ _telemetry_batch }}"

    - name:                         "No parameters: send check-level telemetry"
      when:                         "not (check_result.details is defined and check_result.details.parameters is defined and (check_result.details.parameters | length) > 0)"
      include_role:
        name:                       misc
        tasks_from:                 post-telemetry-data.yml
      vars:
        test_group_json_data:       "{{ [{
                                      'TestCaseInvocationId': (check_result.id | default(check_result.check.id | default(''))),
                                      'TestCaseStartTime': (check_result.timestamp | default(now())),
                                      'TestCaseEndTime': (check_result.timestamp | default(now())),
                                      'TestCaseStatus': (check_result.status | default('')),
                                      'TestCaseName': (check_result.name | default(check_result.check.name | default(''))),
                                      'TestCaseDescription': (check_result.details | default(check_result.check.description | default(''))),
                                      'TestGroupInvocationId': lookup('vars', 'test_group_invocation_id', default=''),
                                      'TestGroupStartTime': lookup('vars', 'group_start_time', default=''),
                                      'TestGroupName': lookup('vars', 'group_name', default='ConfigurationChecks'),
                                      'OsVersion': (system_context.os_type | default(system_context.os_version | default(''))),
                                      'TestCaseMessage': (check_result.details | default('')),
                                      'TestCaseDetails': (check_result.details | default('')),
                                      'DurationSeconds': 0,
                                      'StorageType': (system_context.storage_type | default('unknown')),
                                      'PackageVersions': lookup('vars', 'package_versions', default=''),
                                      'Tags': lookup('vars', 'execution_tags', default=''),
                                      'TestExecutionStartTime': (check_result.timestamp | default(now())),
                                      'TestExecutionEndTime': (check_result.timestamp | default(now())),
                                      'TestCaseHostname': (check_result.hostname | default(system_context.hostname | default(''))),
                                      'TestCaseLogMessagesFromSap': (check_result.details | default(''))
                                    } ] }}"
