# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                           HA Testing Framework                            |
# |                                                                            |
# +------------------------------------4--------------------------------------*/
- hosts:                               localhost
  gather_facts:                        true
  name:                                "Setup deployer for HA Testing Framework"
  vars_files:                          "./vars/input-api.yaml"
  tasks:
    - name:                            "Install python azure pacakges required"
      become:                          true
      ansible.builtin.pip:
        name:
          - ansible-runner
          - azure-kusto-data
          - azure-kusto-ingest

- hosts: "{{ sap_sid | upper }}_SCS:
    {{ sap_sid | upper }}_ERS"
  name:                                "Host tasks"
  gather_facts:                        true
  vars_files:                          "./vars/input-api.yaml"
  tasks:
    - name:                            "Enable profile_tasks callback plugin"
      ansible.builtin.set_fact:
        ansible_callbacks:
          profile_tasks:               true

    - name:                            "Set the test group name based on the inputs"
      ansible.builtin.set_fact:
        test_group_name:               "{{ sap_functional_test_type_map
                                            | selectattr('name', 'equalto', sap_functional_test_type)
                                            | map(attribute='value')
                                            | first }}"
      run_once:                        true

    - name:                             "Get the ERS resource IDs"
      ansible.builtin.shell: |
                                        cibadmin --query --xpath "//primitive[@type='SAPInstance']" | awk '
                                        /<primitive / { id=""; is_ers=0 }
                                        /<primitive / && /id="/ { match($0, /id="([^"]+)"/, m); id=m[1] }
                                        /IS_ERS/ { is_ers=1 }
                                        /<\/primitive>/ {
                                          if (is_ers) print id
                                          id=""; is_ers=0
                                        }'
      register:                         ers_resource_id
      changed_when:                     false
      run_once:                         true

    - name:                            "Get the ASCS resource IDs"
      ansible.builtin.shell: |
                                       cibadmin --query --xpath "//primitive[@type='SAPInstance']" | awk '
                                        /<primitive / { id=""; is_ers=0 }
                                        /<primitive / && /id="/ { match($0, /id="([^"]+)"/, m); id=m[1] }
                                        /IS_ERS/ { is_ers=1 }
                                        /<\/primitive>/ {
                                          if (!is_ers) print id
                                          id=""; is_ers=0
                                        }'
      register:                         ascs_resource_id
      changed_when:                     false
      run_once:                         true

    - name:                            Set the test group facts
      ansible.builtin.set_fact:
        test_group_start_time:         "{{ now(utc=true,fmt='%Y-%m-%d %H:%M:%S') }}"
        test_group_invocation_id:      "{{ lookup('pipe', 'uuidgen') }}"
        test_cases:                    "{{ test_groups
                                            | selectattr('name', 'equalto', test_group_name)
                                            | map(attribute='test_cases') | list | flatten(levels=1)
                                            | selectattr('enabled', 'equalto', true) | list }}"
      run_once:                        true

    - name:                            "Run test cases by including them as roles"
      ansible.builtin.include_tasks:   "./roles/{{ test_group_name | lower }}/tasks/{{ item.task_name }}.yml"
      loop:                            "{{ test_cases | list }}"
      vars:
        group_invocation_id:           "{{ test_group_invocation_id }}"
        group_start_time:              "{{ test_group_start_time }}"
        group_name:                    "{{ sap_functional_test_type }}"
      when:                            test_group_name is defined

    - name:                            "Run test cases by including them as roles"
      ansible.builtin.include_tasks:   "./roles/misc/tasks/render-html-report.yml"
      when:                            test_group_name is defined
